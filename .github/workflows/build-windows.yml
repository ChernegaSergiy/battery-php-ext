name: Build Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    name: Build (Windows x64 PHP ${{ matrix.php }})
    runs-on: windows-latest
    strategy:
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        id: setup-php
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install dependencies
        shell: cmd
        run: |
          choco install -y winflexbison3 re2c
          if exist C:\ProgramData\chocolatey\bin\win_bison.exe copy C:\ProgramData\chocolatey\bin\win_bison.exe C:\ProgramData\chocolatey\bin\bison.exe

      - name: Download PHP Dev Pack
        shell: pwsh
        run: |
          $phpVersion = php -r "echo PHP_VERSION;"
          Write-Host "PHP Version: $phpVersion"
          
          # Try NTS first, then TS if NTS fails
          $urls = @(
            "https://windows.php.net/downloads/releases/php-devel-pack-$phpVersion-nts-Win32-vs16-x64.zip",
            "https://windows.php.net/downloads/releases/php-devel-pack-$phpVersion-Win32-vs16-x64.zip",
            "https://windows.php.net/downloads/releases/php-devel-pack-$phpVersion-nts-Win32-VS16-x64.zip"
          )
          
          $downloaded = $false
          foreach ($url in $urls) {
            Write-Host "Trying: $url"
            try {
              Invoke-WebRequest -Uri $url -OutFile php-devel.zip -ErrorAction Stop
              $downloaded = $true
              Write-Host "Successfully downloaded from: $url"
              break
            } catch {
              Write-Host "Failed: $_"
            }
          }
          
          if (-not $downloaded) {
            throw "Could not download PHP Dev Pack for version $phpVersion"
          }
          
          Expand-Archive php-devel.zip -DestinationPath .
          
          $devPackDir = Get-ChildItem -Directory | Where-Object { $_.Name -like "php-*-devel-*" } | Select-Object -First 1
          $devPackPath = $devPackDir.FullName
          
          Write-Host "Dev Pack extracted to: $devPackPath"
          
          echo "$devPackPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build extension
        shell: cmd
        run: |
          call phpize
          cscript /nologo configure.js --enable-battery_info
          nmake

      - name: Test extension
        shell: cmd
        run: |
          php -d extension=x64\Release\php_battery_info.dll -m | findstr battery_info
          php -d extension=x64\Release\php_battery_info.dll example.php

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: battery_info-windows-php${{ matrix.php }}
          path: 'x64/Release/php_battery_info.dll'
