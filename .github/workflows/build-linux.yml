name: Build Linux

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  EXT_NAME: battery_info

jobs:
  build-x86_64:
    name: Build (Linux x86_64, PHP ${{ matrix.php }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}

      - name: Install build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y autoconf automake libtool pkg-config build-essential

      - name: Build extension
        run: |
          phpize
          ./configure --enable-${EXT_NAME}
          make -j$(nproc)

      - name: Test extension
        run: |
          php -d extension=modules/${EXT_NAME}.so -m | grep ${EXT_NAME}
          php -d extension=modules/${EXT_NAME}.so example.php

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${EXT_NAME}-x86_64-linux-php${{ matrix.php }}
          path: modules/
  

  build-linux:
    name: Build (Linux ${{ matrix.label }}, PHP ${{ matrix.php }})
    runs-on: ${{ matrix.runner }}
    continue-on-error: ${{ matrix.qemu }}
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']
        include:
          - label: aarch64
            arch: aarch64
            runner: ubuntu-24.04-arm
            qemu: false

          - label: armhf
            arch: armv7
            runner: ubuntu-latest
            distro: ubuntu22.04
            qemu: true

    steps:
      - uses: actions/checkout@v4

      # Native ARM64
      - name: Build natively (ARM64)
        if: matrix.qemu == false
        run: |
          sudo add-apt-repository -y ppa:ondrej/php
          sudo apt-get update -y
          sudo apt-get install -y \
            php${{ matrix.php }} \
            php${{ matrix.php }}-dev \
            php${{ matrix.php }}-cli \
            autoconf automake libtool pkg-config build-essential

          phpize
          ./configure --enable-${EXT_NAME}
          make -j$(nproc)

          php -d extension=modules/${EXT_NAME}.so -m | grep ${EXT_NAME} || true
          php -d extension=modules/${EXT_NAME}.so example.php || true

      # QEMU (armhf)
      - name: Build with QEMU (ARMv7 / armhf)
        if: matrix.qemu == true
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: ${{ matrix.arch }}
          distro: ${{ matrix.distro }}
          githubToken: ${{ github.token }}

          env: |
            EXT_NAME: battery_info

          install: |
            apt-get update -y
            apt-get install -y software-properties-common
            add-apt-repository -y ppa:ondrej/php
            apt-get update -y
            apt-get install -y \
              php${{ matrix.php }} \
              php${{ matrix.php }}-dev \
              php${{ matrix.php }}-cli \
              autoconf automake libtool pkg-config build-essential file

          run: |
            phpize
            ./configure --enable-${EXT_NAME}
            make -j$(nproc)

            php -d extension=modules/${EXT_NAME}.so -m | grep ${EXT_NAME} || true
            php -d extension=modules/${EXT_NAME}.so example.php || true

            mkdir -p artifacts
            cp -r modules artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${EXT_NAME}-${{ matrix.label }}-linux-php${{ matrix.php }}
          path: ${{ matrix.qemu && 'artifacts/modules' || 'modules' }}
