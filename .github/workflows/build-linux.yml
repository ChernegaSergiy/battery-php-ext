name: Build Linux

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-x86_64:
    name: Build (Linux x86_64)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config build-essential

      - name: Build extension
        run: |
          phpize
          ./configure --enable-battery_info
          make -j$(nproc)

      - name: Test extension
        run: |
          php -d extension=modules/battery_info.so -m | grep battery_info
          php -d extension=modules/battery_info.so example.php

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: battery_info-x86_64-linux-php${{ matrix.php }}
          path: ./modules

  build-multiarch:
    name: Build (Linux ${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: aarch64
            distro: ubuntu22.04
            php: '8.1'
          - arch: aarch64
            distro: ubuntu22.04
            php: '8.2'
          - arch: aarch64
            distro: ubuntu22.04
            php: '8.3'
          - arch: aarch64
            distro: ubuntu22.04
            php: '8.4'
          - arch: armv7
            distro: ubuntu22.04
            php: '8.1'
          - arch: armv7
            distro: ubuntu22.04
            php: '8.2'
          - arch: armv7
            distro: ubuntu22.04
            php: '8.3'
          - arch: armv7
            distro: ubuntu22.04
            php: '8.4'

    steps:
      - uses: actions/checkout@v4

      - name: Build on ${{ matrix.arch }}
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: ${{ matrix.arch }}
          distro: ${{ matrix.distro }}
          githubToken: ${{ github.token }}
          
          install: |
            apt-get update -q -y
            apt-get install -q -y software-properties-common
            add-apt-repository -y ppa:ondrej/php
            apt-get update -q -y
            apt-get install -q -y php${{ matrix.php }} php${{ matrix.php }}-dev php${{ matrix.php }}-cli \
              autoconf automake libtool pkg-config build-essential file
          
          run: |
            phpize
            ./configure --enable-battery_info
            make -j$(nproc)
            
            # Test
            php -d extension=modules/battery_info.so -m | grep battery_info || true
            php -d extension=modules/battery_info.so example.php || true
            
            # Create artifact directory
            mkdir -p artifacts
            cp -r modules artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: battery_info-${{ matrix.arch }}-linux-php${{ matrix.php }}
          path: artifacts/modules
